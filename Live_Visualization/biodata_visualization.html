<!DOCTYPE HTML>
<html>
    <head>
        <title>Live Visualization</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/reset.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/application.min.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/jquery.fullPage.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/radar-chart.css" type="text/css" media="screen" charset="utf-8" />
        <link type="text/css" rel="stylesheet" href="../rickshaw-master/rickshaw.min.css">
        <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
        <script type="text/javascript" src="js/jq.js"></script>
        <script type="text/javascript" src="js/sb-1.4.1.js"></script>
        <script type="text/javascript" src="../rickshaw-master/vendor/d3.min.js"></script>
        <script type="text/javascript" src="../rickshaw-master/rickshaw.min.js"></script>
        <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="js/jquery-migrate-1.2.1.min.js"></script>
        <script type="text/javascript" src="js/jquery.countdown360.js"></script>

    </head>
    <body class="background-dark">
        <div class="container">

            <header class="page-header">
                <div class="navbar">
                    <div class="logo pull-left">
                        <h2><a href="index.html">Change Your Mind</strong></a> <small>0.4</small></h2>
                    </div>
                    <ul class="nav navbar-nav navbar-right pull-right">
                        <li class="connection">
                            <div class="ecg-indicator">
                                <i class="fa fa-circle text-danger"></i>
                            </div>
                            <span class="label-name" id="ecg_state">ECG: Not Connected</span>
                        </li>
                        <li class="sensor"><div class="eeg-sensor1"> <i class="fa fa-circle text-muted"></i></div></li>
                        <li class="sensor"><div class="eeg-sensor2"> <i class="fa fa-circle text-muted"></i></div></li>
                        <li class="sensor"><div class="eeg-sensor3"> <i class="fa fa-circle text-muted"></i></div></li>
                        <li class="sensor"><div class="eeg-sensor4"> <i class="fa fa-circle text-muted"></i></div></li>

                        <li class="connection">
                            <div class="eeg-indicator"><i class="fa fa-circle text-danger"></i></div>
                            <span class="label-name" id="eeg_state">EEG: Not Connected</span>
                            </li>
                    </ul>
                </div>
            </header>

            <div class="content" id="fullpage">
                <div class="row section" id="section">
                    <div class="col-lg-12">
                        <section class="widget">
                            <header>
                                <h4>Instructions</h4>
                            </header>
                            <div id="instructions">Explore how intention can change your mind (alpha brain oscillations: EEG) and body (Heart Rate Variability: ECG).<br/>This experience will take 3 minutes to complete once you have successful connection with the Muse headset.<br/>Please place your hands on  to begin.</div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">

                    <div class="col-lg-8">
                        <section class="widget">
                            <header>
                                <h4>EEG Baseline Collection</h4>
                            </header>
                            <div class="histogram">
                                <div id="eeg_graph_baseline"></div>
                                <div id="eeg_legend_baseline"></div>
                                <!-- <br><br> -->
                            </div>
                        </section>
                        <section class="widget">
                            <header>
                                <h4>Heart Rate Variability (HRV) Baseline Collection</h4>
                            </header>
                            <div class="histogram">
                                <div id="ecg_graph_baseline"></div>
                                <div id="ecg_legend_baseline"></div>
                                <!-- <br><br> -->
                            </div>
                        </section>
                    </div>

                    <div class="col-lg-4">
                        <section class="widget">
                            <header>
                             <!-- header -->
                            </header>
                            <div class="widget-body">
                            <!-- <div id="msg-content"></div> -->
                                <div id="message"></div>
                                <div id="countdown"></div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h4>Current EEG Alpha vs Baseline Average</h4>
                            </header>
                            <div class="histogram_condition">
                                <div id="eeg_graph_condition"></div>
                                <div id="eeg_legend_condition"></div>
                                <!-- </br></br> -->
                            </div>
                        </section>
                        <section class="widget">
                            <header>
                                <h4>Current ECG Heart Rate Variability vs Baseline
                                    <!-- <small>Real-time Plot</small> -->
                                </h4>
                            </header>
                            <div class="histogram_condition">
                                <div id="ecg_graph_condition"></div>
                                <div id="ecg_legend_condition"></div>
                                <!-- </br></br> -->
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h4>
                                    Your Breath
                                </h4>
                            </header>
                            <div id="bloom"></div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                <!-- <div class="row section" id="section"> -->
                    <div class="col-lg-6">
                        <section class="widget">
                                <div id="bar-legend">
                                    <i class="fa fa-circle" id="baseline-bar"></i> Your Baseline (Before)
                                        <br>
                                    <i class="fa fa-circle" id="condition-bar"></i> Current (After Exercise)
                                </div>
                            <!-- <div id="barchart1"> -->
                                <div id="barchart1" style="width: 100%">
                                    <canvas id="canvas1" style="height=250px; width=275px;"></canvas>
                                    <canvas id="canvas2" style ="height=250px; width=275px;"></canvas>
                                </div>
                            <!-- </div> -->
                        </section>
                        <section class="widget">
                            <div id="bar-legend">
                                <i class="fa fa-circle" id="baseline-radar"></i> Before
                                    <br>
                                <i class="fa fa-circle" id="condition-radar"></i> After
                            </div>
                            <!-- <div class="chart-container"> -->
                            <div id="radarchart1">
                                <canvas id="canvas_radar"></canvas>
                               <!-- <div id="radar-chart"></div>-->
                            </div>
                        </section>
                        <section class="widget">
                            <div class="description">
                                Email <u>change.brain.exploratorium@gmail.com</u> with questions or feedback.
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h3>
                                    New User?
                                </h3>
                            </header>
                            <h3 class="description" id="new-user-description">
                                Tap your RFID tag to begin. This experience will take 3 minutes to complete.
                            </h3>
                        </section>
                        <section class="widget">
                            <header>
                                <h3>
                                    Understanding your scores
                                </h3>
                            </header>
                            <h3 class="description" id="result-description">
                                Slowing your breath is one way to calm your mind and rest your body. Higher power in the <strong>alpha</strong> frequency band (8-14 Hz) can indicate a more relaxed mental state. Higher <strong>heart rate variability</strong> (HRV, variance in heart rate) can indicate a relaxed state and greater responsiveness to your environment.<br/>Notice how your perceived states (calm, content, distraction, happiness) may have changed over the exercise!


                            </h3>
                        </section>

                        <!-- </div> -->
                    </div>
                <!-- </div> -->
                </div>
            </div>

        </div>
        <script type="text/javascript" src="js/d3.v3.min.js"></script>
        <script type="text/javascript" src="js/bloom.js"></script>
        <script type="text/javascript" src="js/Chart.js"></script>
        <script type="text/javascript" src="js/jquery.fullPage.js"></script>
        <script type="text/javascript" src="js/radar-chart.js"></script>
        <script type="text/javascript" src="js/main.js"></script>
        <script type="text/javascript">
            // variables to change
            var bufferLength = 120;
            var port_in = 9002;
            var host = '127.0.0.1';
            // display messages
            var eeg_disconnected_text = "EEG: Not Connected";
            var ecg_disconnected_text = "ECG: Not Connected";
            var eeg_connected_text = "EEG: Connected";
            var ecg_connected_text = "ECG: Connected";
            var not_started_text = "Please put on the Muse headset to begin.";
            // initialize program variables
            var eeg_state = "DISCONNECTED";
            var ecg_state = "DISCONNECTED";
            var indicator_connected = '<i class="fa fa-circle text-success"></i>';
            var indicator_disconnected = '<i class="fa fa-circle text-danger"></i>';
            var indicator_connectedok = '<i class="fa fa-circle text-warning"></i>';
            var indicator_connectedbad = '<i class="fa fa-circle text-muted"></i>';
            var eeg_buffer = [];
            var ecg_buffer = [];
            var baseline_eeg_buffer = [];
            var baseline_hrv_buffer = [];

            var sb, app_name = "Change_your_mind"; //Biodata (ECG + EEG viz) is booth 5!
            var app_description = "Charts realtime alpha_relative to baseline (EEG) and HRV relative to baseline (ECG) data";
            // when window loads call the setup method
            $(window).on("load", setup);
            // Spacebrew Object
            //set up graph & axes in Rickshaw

            var graph_height_baseline = 250;
            // var graph_width = 500;
            var graph_width_baseline = 620;

            var graph_width_condition = 440;
            var graph_height_condition = 220;

            var eeg_graph_baseline = new Rickshaw.Graph( {
                element: document.querySelector("#eeg_graph_baseline"),
                width: graph_width_baseline,
                height: graph_height_baseline,
                min: -1,
                max: 1,
                renderer: 'line',
                series: [{
                    color: 'steelblue',
                    data: [],
                    name: "EEG - Alpha band power"
                    }]
            });

            var ecg_graph_baseline = new Rickshaw.Graph( {
                element: document.querySelector("#ecg_graph_baseline"),
                width: graph_width_baseline,
                height: graph_height_baseline,
                renderer: 'line',

                series: [{
                    color: "rgb(207, 109, 81)",
                    data: [],
                    name: "ECG - Heart rate variability (HRV)"
                }]
            });
            // a = [{x: 1, y: 2}, {x: 12, y: 13}];
            var eeg_graph_condition = new Rickshaw.Graph( {
                element: document.querySelector("#eeg_graph_condition"),
                width: graph_width_condition,
                height: graph_height_condition,
                renderer: 'line',
                min: -1,
                max: 1,
                series: [{
                    color: 'steelblue',
                     data: [],
                     name: "EEG alpha - condition"
                    },
                    {
                    color: 'black',
                     data: [],
                     name: "EEG alpha - baseline"
                    }
                    ]
            });

            var ecg_graph_condition = new Rickshaw.Graph( {
                element: document.querySelector("#ecg_graph_condition"),
                width: graph_width_condition,
                height: graph_height_condition,
                renderer: 'line',
                series: [{
                    color: "rgb(207, 109, 81)",
                    data: [],
                    name: "ECG HRV - condition"
                },
                {
                    color: 'black',
                    data: [],
                    name: "ECG HRV - baseline"
                    }]
            });
            make_axes();

            var legend_1 = new Rickshaw.Graph.Legend({
                graph: eeg_graph_baseline,
                element: document.querySelector('#eeg_legend_baseline')
            });
            var legend_2 = new Rickshaw.Graph.Legend({
                graph: ecg_graph_baseline,
                element: document.querySelector('#ecg_legend_baseline')
            });
            var legend_3 = new Rickshaw.Graph.Legend({
                graph: eeg_graph_condition,
                element: document.querySelector('#eeg_legend_condition')
            });
            var legend_4 = new Rickshaw.Graph.Legend({
                graph: ecg_graph_condition,
                element: document.querySelector('#ecg_legend_condition')
            });

            legend_1.render();
            legend_2.render();
            legend_3.render();
            legend_4.render();

            var eeg_graph_to_plot = eeg_graph_baseline;
            var ecg_graph_to_plot = ecg_graph_baseline;

            var alpha_avg_baseline = 0;
            var hrv_avg_baseline = 0;

/**
* setup Function that connect to spacebrew and creates a listener for data being passed from biodata_spacebrew_client.py
*/
function setup (){
// setup spacebrew
    sb = new Spacebrew.Client(host,app_name,app_description,{port:port_in}); // create spacebrew client object
    // create the spacebrew subscription channels
    sb.addSubscribe("instruction", "string");
    sb.addSubscribe("eeg_ecg", "string"); // create the subscription feed
    // configure the publication and subscription feeds
    sb.onStringMessage = onStringMessage;
    sb.onOpen = onOpen;
    sb.onClose = onClose;
    // connect to spacbrew
    sb.connect();

    /*var finalData = [];

       finalData[0] = 0.5;
       finalData[1] = 0.7;

       finalData[2] = 0.4;
       finalData[3] = 0.6;

       drawBarChart(finalData);

       var beforeValues = [1,3,2,4];
       var afterValues = [5,3,4,5];
       drawRadarChart(beforeValues,afterValues);*/
}
/**
* Function that is called when Spacebrew connection is established
*/
function onOpen() {
    console.log("spacebrew client connection opened")
    $("#eeg_state").html( eeg_disconnected_text );
    $("#ecg_state").html( ecg_disconnected_text );
    $('.eeg-indicator').html(indicator_disconnected);
    $('.eeg-sensor1').html(indicator_connectedbad);
    $('.eeg-sensor2').html(indicator_connectedbad);
    $('.eeg-sensor3').html(indicator_connectedbad);
    $('.eeg-sensor4').html(indicator_connectedbad);
    $('.ecg-indicator').html(indicator_disconnected);
}

function onClose() {
    var message = "Trying to connect";
    $("#eeg_state").html( eeg_disconnected_text );
    $("#ecg_state").html( ecg_disconnected_text );
    //$("#message").html( message );
    $('.eeg-indicator').html(indicator_disconnected);
    $('.eeg-sensor1').html(indicator_connectedbad);
    $('.eeg-sensor2').html(indicator_connectedbad);
    $('.eeg-sensor3').html(indicator_connectedbad);
    $('.eeg-sensor4').html(indicator_connectedbad);
    $('.eeg-indicator').html(indicator_disconnected);
}
/**
* onStringMessage Function that is called whenever new spacebrew string messages are received.
* It accepts two parameters:
* @param {String} name Holds name of the subscription feed channel
* @param {String} value Holds value received from the subscription feed
*/
function onStringMessage( name, value ){
console.log("[onStringMessage] string message received ", value);
//$("#msg_received").text(value); // display the sent message in the browser
if (name == 'instruction')
{
	update_ui(value);
}
else if (name == "eeg_ecg")
{
    var arrVal = value.split(",");

	var timestamp = +arrVal[0];
	var eeg_point = +arrVal[1];
	var ecg_point = +arrVal[2];

    //console.log("eeg point " + eeg_point)

	if (eeg_buffer.length > bufferLength){
		eeg_buffer.shift();
	}
	eeg_buffer.push({"x":timestamp,"y":eeg_point});

	if (ecg_buffer.length > bufferLength){
		ecg_buffer.shift();
	}
	ecg_buffer.push({"x":timestamp,"y":ecg_point});

    if (eeg_graph_to_plot == eeg_graph_condition)
    {
        if (baseline_eeg_buffer.length > bufferLength){
            baseline_eeg_buffer.shift();
        }
        baseline_eeg_buffer.push({"x":timestamp,"y":alpha_avg_baseline});
        eeg_graph_condition.series[1].data = baseline_eeg_buffer;
        eeg_graph_condition.render();
    }

    if (ecg_graph_to_plot == ecg_graph_condition)
    {
        if (baseline_hrv_buffer.length > bufferLength){
            baseline_hrv_buffer.shift();
        }
        baseline_hrv_buffer.push({"x":timestamp,"y":hrv_avg_baseline});
        ecg_graph_condition.series[1].data = baseline_hrv_buffer;
        ecg_graph_condition.render();
      }

	   update_graph(eeg_buffer,eeg_graph_to_plot);
	   update_graph(ecg_buffer,ecg_graph_to_plot);

}

}

function update_graph(data,graph)
{
    graph.series[0].data = data;

    graph.render();
    //console.log(chart.series[0].data[0]);
}

function clear_graph()
{
}

function update_ui(instruction)
{

    if (instruction.instruction_name == "DISPLAY_INSTRUCTION")
    {
      var message = instruction.instruction_text;
      $("#instructions").html(message)
      $(document).trigger('goTo',1);
    }
    else if (instruction.instruction_name == "BASELINE_COLLECTION")
    {
        console.log("baseline collection started");
        var baseline_seconds = instruction.display_seconds;
        // start timer
        eeg_graph_to_plot = eeg_graph_baseline;
        ecg_graph_to_plot = ecg_graph_baseline;

        eeg_buffer = [];
        ecg_buffer = [];

        start_baseline_timer(baseline_seconds);
        $(document).trigger('goTo',2);

    }
    else if (instruction.instruction_name == "CONDITION_COLLECTION")
    {
       console.log("condition began");
	   var display_seconds = instruction.display_seconds;
       eeg_buffer = [];
       ecg_buffer = [];

       baseline_hrv_buffer = [];
       baseline_eeg_buffer = [];

       alpha_avg_baseline = instruction.baseline_alpha;
       hrv_avg_baseline =  instruction.baseline_hrv;

        eeg_graph_to_plot = eeg_graph_condition;
        ecg_graph_to_plot = ecg_graph_condition;
        //ecg_graph_condition.series[1].data = baseline_series;

	   $(document).trigger('goTo',3);
    }
    else if (instruction.instruction_name == "POST_EXPERIMENT")
    {
	   $(document).trigger('goTo',4);
       var baseline_alpha = instruction.baseline_alpha;
       var baseline_hrv = instruction.baseline_hrv;
       var condition_alpha = instruction.condition_alpha;
       var condition_hrv = instruction.condition_hrv;

       var finalData = [];

       finalData[0] = baseline_hrv;
       finalData[1] = condition_hrv;

       finalData[2] = baseline_alpha;
       finalData[3] = condition_alpha;

       drawBarChart(finalData);

       var beforeValues = instruction.baseline_subj;
       var afterValues = instruction.condition_subj;
       drawRadarChart(beforeValues,afterValues);

       console.log("before values: " + beforeValues + " after values: " + afterValues)


    }
    else if (instruction.instruction_name == "EEG_SENSOR") {
        for (i=0; i<4; i++) {
            var n = instruction.sensorstate[i]
            var ns = n.toString()
            var name = ".eeg_sensor"
            name = name.concat(ns)
            if (n==1) {
                $(name).html(indicator_connected)
            }
            else if (n==2) {
                $(name).html(indicator_connectedok)
            }
            else {
                $(name).html(indicator_connectedbad)   
            }
        }
    }
    else if (instruction.instruction_name == "CONNECTED")
    {
	    if (instruction.type == "eeg"){
		    $("#eeg_state").html( eeg_connected_text );
            $('.eeg-indicator').html(indicator_connected);
	    }
    	else if (instruction.type == "ecg")
    	{
    		$("#ecg_state").html( ecg_connected_text );
            $('.ecg-indicator').html(indicator_connected);
    	}
    }

    else if (instruction.instruction_name == "DISCONNECTED")
    {
    	if (instruction.type == "eeg"){
    		$("#eeg_state").html( eeg_disconnected_text );
            $('.eeg-indicator').html(indicator_disconnected);
    	}
    	else if (instruction.type == "ecg")
    	{
    		$("#ecg_state").html( ecg_disconnected_text );
            $('.ecg-indicator').html(indicator_disconnected);
    	}

    }
}


function start_baseline_timer(seconds)
{
    console.log("start baseline timer called with " + seconds + " seconds");
                var countdown = $("#countdown").countdown360({
                 radius: 95,
                 seconds: seconds,
                 label: ['sec', 'secs'],
                 fontColor: '#FFFFFF',
                 strokeStyle: '#f5f5f5',
                 fillStyle: '#e5603b',
                 autostart: false,
                 onComplete: function () {
                      console.log('done');
                 }
            });
    countdown.start();
}


function make_graphs()
{

}

function make_axes()
{
    var xAxis_eeg = new Rickshaw.Graph.Axis.X({
                graph: eeg_graph_baseline,
                orientation: 'bottom',
                });
    xAxis_eeg.render();

    var yAxis_eeg = new Rickshaw.Graph.Axis.Y({
                graph: eeg_graph_baseline
                });
    yAxis_eeg.render();

    var xAxis_ecg = new Rickshaw.Graph.Axis.X({
                graph: ecg_graph_baseline,
                orientation: 'bottom',
                });
    xAxis_ecg.render();

    var yAxis_ecg = new Rickshaw.Graph.Axis.Y({
                graph: ecg_graph_baseline
                });
    yAxis_ecg.render();

    var xAxis_eeg_cond = new Rickshaw.Graph.Axis.X({
                graph: eeg_graph_condition,
                orientation: 'bottom',
                });
    xAxis_eeg_cond.render();

    var yAxis_eeg_cond = new Rickshaw.Graph.Axis.Y({
                graph: eeg_graph_condition
                });
    yAxis_eeg_cond.render();

    var xAxis_ecg_cond = new Rickshaw.Graph.Axis.X({
                graph: ecg_graph_condition,
                orientation: 'bottom',
                });
    xAxis_ecg_cond.render();

    var yAxis_ecg_cond = new Rickshaw.Graph.Axis.Y({
                graph: ecg_graph_condition
                });
    yAxis_ecg_cond.render();
}

function makeAverageBaseline(value, buffer) {
  var arr = [];
  for (var i = 0; i < buffer.length; i++) {
    arr.push({"x":buffer[i].x,"y":value});
  }
  return arr;
}

// start_baseline_timer()

</script>
</body>
</html>
